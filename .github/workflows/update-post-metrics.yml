name: Update Post Metrics

on:
  schedule:
    # Check every 2 hours for potential updates (12 checks per day)
    # Time Window + Escalating Probability pattern for natural, human-like behavior
    - cron: '0 */2 * * *'  # Every 2 hours

  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write  # Required for git push

jobs:
  update-metrics:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Filter time window (human hours only)
        id: time_window
        run: |
          current_hour_wib=$(TZ='Asia/Jakarta' date +%H)

          echo "üïê Current time: $(TZ='Asia/Jakarta' date '+%Y-%m-%d %H:%M:%S %Z')"

          # Only allow updates during active hours: 06:00-21:59 WIB
          # (Avoid sleep hours: 22:00-05:59 WIB)
          if [ $current_hour_wib -lt 6 ] || [ $current_hour_wib -ge 22 ]; then
            echo "‚è∞ Outside active hours (${current_hour_wib}:00 WIB - sleep time)"
            echo "   Active window: 06:00-21:59 WIB"
            echo "should_continue=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "‚úÖ Within active hours (${current_hour_wib}:00 WIB)"
          echo "should_continue=true" >> $GITHUB_OUTPUT

      - name: Check last run and calculate probability
        id: check_update
        if: steps.time_window.outputs.should_continue == 'true'
        run: |
          # Get last commit timestamp from post files
          last_run=$(git log -1 --format=%ct _posts/ 2>/dev/null || echo 0)
          current_time=$(date +%s)
          hours_since=$(( (current_time - last_run) / 3600 ))
          days_since=$(echo "scale=1; $hours_since / 24" | bc)

          echo "üìÖ Last update: $(date -d @$last_run '+%Y-%m-%d %H:%M:%S %Z' 2>/dev/null || echo 'Never')"
          echo "üìä Time since last update: $hours_since hours ($days_since days)"

          # Escalating probability based on time since last run
          # Minimum gap: 48 hours (2 days)
          if [ $hours_since -lt 48 ]; then
            probability=0
            echo "‚è≠Ô∏è  Too recent ($hours_since hours < 48 hours minimum)"
            echo "should_update=false" >> $GITHUB_OUTPUT
            exit 0
          elif [ $hours_since -lt 72 ]; then
            # 2-3 days: 10% chance
            probability=10
          elif [ $hours_since -lt 96 ]; then
            # 3-4 days: 25% chance
            probability=25
          elif [ $hours_since -lt 120 ]; then
            # 4-5 days: 50% chance
            probability=50
          else
            # 5+ days: 90% chance (getting urgent!)
            probability=90
          fi

          # Roll the dice
          random=$((RANDOM % 100))

          echo "üé≤ Probability: $probability% | Random roll: $random"

          if [ $random -lt $probability ]; then
            echo "‚úÖ HIT! ($random < $probability) - Proceeding with update"
            echo "should_update=true" >> $GITHUB_OUTPUT
          else
            echo "‚è≠Ô∏è  MISS! ($random >= $probability) - Skipping this check"
            echo "should_update=false" >> $GITHUB_OUTPUT
          fi

      - name: Random timing variation (make timestamp unique)
        if: steps.check_update.outputs.should_update == 'true'
        run: |
          # Add random delay: 0-59 minutes + 0-59 seconds
          # This ensures every execution has a unique timestamp
          delay_minutes=$((RANDOM % 60))
          delay_seconds=$((RANDOM % 60))
          total_delay=$((delay_minutes * 60 + delay_seconds))

          echo "‚è∞ Adding timing variation: ${delay_minutes}m ${delay_seconds}s"
          echo "   This makes the exact execution time unpredictable and unique"

          sleep $total_delay

          final_time=$(TZ='Asia/Jakarta' date '+%Y-%m-%d %H:%M:%S %Z')
          echo "‚úÖ Executing at: $final_time"

      - name: Setup Ruby
        if: steps.check_update.outputs.should_update == 'true'
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.0'

      - name: Update engagement metrics
        if: steps.check_update.outputs.should_update == 'true'
        run: |
          echo "üöÄ Running hybrid post update system..."
          cd public_html
          ruby scripts/update-post-hybrid.rb

      - name: Check for changes
        id: check_changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.check_changes.outputs.has_changes == 'true' && steps.check_update.outputs.should_update == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add _posts/*.md

          # Get actual execution time for commit message
          execution_time=$(date '+%Y-%m-%d %H:%M %Z')

          git commit -m "chore: auto-update post engagement with dynamic comments

          - Automated post engagement update (hybrid system v1.0)
          - Updated like_count and share_count via Ruby script
          - Dynamic comment generation (every 10th update)
          - Execution time: ${execution_time}
          - Natural timing: Time Window + Escalating Probability pattern
          - Triggered by scheduled workflow: update-post-metrics.yml"

          git push

      - name: No changes
        if: steps.check_changes.outputs.has_changes == 'false'
        run: echo "No metrics updated today"
