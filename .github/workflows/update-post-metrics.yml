name: Update Post Metrics

on:
  schedule:
    # Varied schedule for natural timing (multiple times per week)
    # Monday slots (alternating weeks via random delay)
    - cron: '45 23 * * 0'  # Sunday 23:45 UTC (Mon 06:45 WIB)
    - cron: '30 1 * * 1'   # Monday 01:30 UTC (08:30 WIB)

    # Thursday slots (alternating weeks via random delay)
    - cron: '15 2 * * 4'   # Thursday 02:15 UTC (09:15 WIB)
    - cron: '0 4 * * 4'    # Thursday 04:00 UTC (11:00 WIB)

  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write  # Required for git push

jobs:
  update-metrics:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Random timing delay for natural appearance
        run: |
          # Add random delay 0-90 minutes for unpredictable timing
          delay_minutes=$((RANDOM % 90))
          delay_seconds=$((delay_minutes * 60))

          echo "â° Adding natural timing variation: ${delay_minutes} minutes"
          echo "   This makes updates appear more organic and less automated"
          echo "   Sleeping for ${delay_seconds} seconds..."

          sleep ${delay_seconds}

          actual_time=$(date '+%Y-%m-%d %H:%M:%S %Z')
          echo "âœ… Timing delay complete. Starting update at: ${actual_time}"

      - name: Check if already updated recently
        id: check_update
        run: |
          # Get last commit date from post files
          last_update=$(git log -1 --format=%cd --date=short _posts/ 2>/dev/null || echo "1970-01-01")
          days_since=$((( $(date +%s) - $(date -d "$last_update" +%s) ) / 86400))

          echo "ðŸ“… Last update: $last_update"
          echo "ðŸ“Š Days since last update: $days_since"

          # Only proceed if it's been 2+ days since last update
          if [ $days_since -ge 2 ]; then
            echo "should_update=true" >> $GITHUB_OUTPUT
            echo "âœ… Proceeding with update (2+ days since last)"
          else
            echo "should_update=false" >> $GITHUB_OUTPUT
            echo "â­ï¸  Skipping update (updated recently: $days_since days ago)"
          fi

      - name: Setup Ruby
        if: steps.check_update.outputs.should_update == 'true'
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.0'

      - name: Update engagement metrics
        if: steps.check_update.outputs.should_update == 'true'
        run: |
          echo "ðŸš€ Running hybrid post update system..."
          cd public_html
          ruby scripts/update-post-hybrid.rb

      - name: Check for changes
        id: check_changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.check_changes.outputs.has_changes == 'true' && steps.check_update.outputs.should_update == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add _posts/*.md

          # Get actual execution time for commit message
          execution_time=$(date '+%Y-%m-%d %H:%M %Z')

          git commit -m "chore: auto-update post engagement with dynamic comments

          - Automated post engagement update (hybrid system v1.0)
          - Updated like_count and share_count via Ruby script
          - Dynamic comment generation (every 10th update)
          - Execution time: ${execution_time}
          - Triggered by scheduled workflow: update-post-metrics.yml"

          git push

      - name: No changes
        if: steps.check_changes.outputs.has_changes == 'false'
        run: echo "No metrics updated today"
