{% comment %}
  ============================================================================
  Schema Include - Product List (ProductGroup with variants)
  ============================================================================

  @file        _includes/schema--product-list.html
  @description Schema markup for product catalog page using ProductGroup.
               Matches front page schema structure for consistency.

  @version     2.0.0
  @date        2025-12-15
  @author      jualkayudolkengelam
  @copyright   2024-2025 Kayu Dolken Gelam - Amirudin Abdul Karim
  @license     All rights reserved

  Features:
  ---------
  - ProductGroup with hasVariant for all products
  - AggregateRating calculated from all products
  - Reviews from _data/featured_reviews.yml (same as front page)
  - Complete Offer fields (price, availability, shipping, returns)

  Usage:
  ------
  {% include schema/schema--product-list.html %}

  Called from:
  ------------
  - product.html (catalog page)

  ============================================================================
{% endcomment %}

{% comment %} Calculate aggregate rating from all products {% endcomment %}
{% assign total_rating = 0 %}
{% assign total_reviews = 0 %}
{% for product in site.products %}
  {% assign product_rating = product.rating | default: 4.5 | times: 1.0 %}
  {% assign product_reviews = product.review_count | default: 45 %}
  {% assign weighted = product_rating | times: product_reviews %}
  {% assign total_rating = total_rating | plus: weighted %}
  {% assign total_reviews = total_reviews | plus: product_reviews %}
{% endfor %}
{% assign avg_rating = total_rating | divided_by: total_reviews | round: 1 %}

{% comment %} Sort products by price {% endcomment %}
{% assign sorted_products = site.products | sort: "price" %}

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "ProductGroup",
  "@id": "{{ page.url | absolute_url }}#product-group",
  "name": "Kayu Dolken Gelam Panjang 4 Meter",
  "description": "Daftar lengkap kayu dolken gelam berkualitas tinggi dengan berbagai ukuran diameter. Cocok untuk konstruksi, pagar, dan dekorasi.",
  "url": "{{ page.url | absolute_url }}",
  "image": "{{ site.url }}{{ site.baseurl }}/assets/images/products/jual-kayu-dolken-gelam-8-10cm-001.jpeg",
  "brand": {
    "@type": "Brand",
    "name": "Kayu Dolken Gelam"
  },
  "productGroupID": "kayu-dolken-gelam-4m",
  "variesBy": "https://schema.org/size",
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": "{{ avg_rating }}",
    "reviewCount": "{{ total_reviews }}",
    "bestRating": "5",
    "worstRating": "1"
  },
  {% if site.data.featured_reviews.reviews %}
  "review": [
    {% assign featured_reviews = site.data.featured_reviews.reviews | slice: 0, 3 %}
    {% for review in featured_reviews %}
    {
      "@type": "Review",
      "author": {
        "@type": "Person",
        "name": "{{ review.author }}"
      },
      "datePublished": "{{ review.date }}",
      "reviewBody": "{{ review.comment | escape }}",
      "reviewRating": {
        "@type": "Rating",
        "ratingValue": "{{ review.rating }}",
        "bestRating": "5",
        "worstRating": "1"
      }
    }{% unless forloop.last %},{% endunless %}
    {% endfor %}
  ],
  {% endif %}
  "hasVariant": [
    {% for product in sorted_products %}
    {
      "@type": "Product",
      "@id": "{{ product.url | absolute_url }}#product",
      "name": "{{ product.title }}",
      "description": "{{ product.description }}",
      "url": "{{ product.url | absolute_url }}",
      {% if product.image %}
      "image": "{{ product.image | absolute_url }}",
      {% endif %}
      "sku": "{{ product.sku }}",
      "size": "{{ product.diameter }}",
      "offers": {
        "@type": "Offer",
        "url": "{{ product.url | absolute_url }}",
        "priceCurrency": "IDR",
        "price": "{{ product.price }}",
        "priceValidUntil": "{{ 'now' | date: '%Y' | plus: 1 }}-12-31",
        "availability": "https://schema.org/InStock",
        "seller": {
          "@id": "{{ site.url }}{{ site.baseurl }}/#organization"
        },
        "shippingDetails": {
          "@type": "OfferShippingDetails",
          "shippingRate": {
            "@type": "MonetaryAmount",
            "value": "0",
            "currency": "IDR"
          },
          "shippingDestination": {
            "@type": "DefinedRegion",
            "addressCountry": "ID"
          },
          "deliveryTime": {
            "@type": "ShippingDeliveryTime",
            "handlingTime": {
              "@type": "QuantitativeValue",
              "minValue": 1,
              "maxValue": 2,
              "unitCode": "DAY"
            },
            "transitTime": {
              "@type": "QuantitativeValue",
              "minValue": 3,
              "maxValue": 7,
              "unitCode": "DAY"
            }
          }
        },
        "hasMerchantReturnPolicy": {
          "@type": "MerchantReturnPolicy",
          "applicableCountry": "ID",
          "returnPolicyCategory": "https://schema.org/MerchantReturnFiniteReturnWindow",
          "merchantReturnDays": 7,
          "returnMethod": "https://schema.org/ReturnByMail",
          "returnFees": "https://schema.org/FreeReturn"
        }
      }
    }{% unless forloop.last %},{% endunless %}
    {% endfor %}
  ]
}
</script>
